// ====== Dados de municípios ======
const municipios = {
  MG: ["Aimorés", "Alpercata", "Tumiritinga"],
  ES: ["Anchieta", "Aracruz", "Sooretama"],
  DF: ["Brasília"]
};

let actionCount = 0;

function updateMunicipios(uf) {
  const select = document.getElementById("municipio-select");
  select.innerHTML = "";
  (municipios[uf] || []).forEach(m => {
    const option = document.createElement("option");
    option.value = m;
    option.textContent = m;
    select.appendChild(option);
  });
}

function toggleAccordion(id) {
  document.querySelectorAll(".accordion-body").forEach(el => {
    if (el.id !== id) el.style.display = "none";
  });
  const el = document.getElementById(id);
  el.style.display = (el.style.display === "block") ? "none" : "block";
}

function removeAction(button) {
  const item = button.closest('.accordion-item');
  item.remove();
}

function createCurrencyMask(input) {
  input.addEventListener('input', function () {
    let value = this.value.replace(/\D/g, '');
    value = (parseInt(value, 10) / 100).toFixed(2).toString();
    value = value.replace('.', ',');
    value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    this.value = value ? 'R$ ' + value : '';
  });
}

function addAction(eixoId) {
  document.querySelectorAll('.accordion-body').forEach(body => {
    body.style.display = 'none';
  });

  actionCount++;
  const eixo = document.getElementById(eixoId);
  const newId = `acao${eixoId}_${actionCount}`;

  const newAction = document.createElement('div');
  newAction.classList.add('accordion-item');

  newAction.innerHTML = `
    <div class="accordion-header" onclick="toggleAccordion('${newId}')" aria-expanded="true" aria-controls="${newId}">Nova Ação</div>
    <div class="accordion-body" id="${newId}" role="region">
      <label>Identificação do Problema:</label>
      <textarea></textarea>

      <label>Nome da ação:</label>
      <input type="text" class="nome-acao">

      <label>Descrição da ação:</label>
      <textarea></textarea>

      <label>Objetivos:</label>
      <textarea></textarea>

      <label>Itens previstos:</label>
      <input type="text">

      <label>Tipo da Ação:</label>
      <select>
        <option>Investimento</option>
        <option>Custeio</option>
      </select>

      <label>Orçamento previsto:</label>
      <input type="text" class="masked-currency" id="budget-${newId}">

      <label>Data de início:</label>
      <input type="date">

      <label>Data de conclusão:</label>
      <input type="date">

      <label>Indicador:</label>
      <input type="text">

      <label>Meta:</label>
      <input type="text">

      <label>Observações:</label>
      <textarea></textarea>
    </div>
  `;

  eixo.appendChild(newAction);

  const nomeInput = newAction.querySelector('.nome-acao');
  const header = newAction.querySelector('.accordion-header');
  nomeInput.addEventListener('input', () => {
    header.innerText = nomeInput.value || 'Nova Ação';
  });

  createCurrencyMask(document.getElementById(`budget-${newId}`));

  const body = newAction.querySelector('.accordion-body');
  const salvarBtn = document.createElement('button');
  salvarBtn.innerText = 'Salvar ação';
  salvarBtn.className = 'add-action';
  salvarBtn.onclick = () => {
    body.style.display = 'none';
    const offset = eixo.getBoundingClientRect().top + window.scrollY - 100;
    window.scrollTo({ top: offset, behavior: 'smooth' });
  };
  body.appendChild(salvarBtn);

  const excluirBtn = document.createElement('button');
  excluirBtn.innerText = 'Excluir ação';
  excluirBtn.className = 'remove-action';
  excluirBtn.onclick = () => removeAction(excluirBtn);
  body.appendChild(excluirBtn);

  toggleAccordion(newId);
  setTimeout(() => {
    const offset = eixo.getBoundingClientRect().top + window.scrollY - 100;
    window.scrollTo({ top: offset, behavior: 'smooth' });
  }, 100);
}

function setupEixos() {
  const eixos = [
    "Fortalecimento e ampliação dos serviços de Atenção à Saúde",
    "Fortalecimento e ampliação das ações e serviços de Vigilância em Saúde",
    "Fortalecimento, ampliação e melhorias da infraestrutura de saúde",
    "Melhoria das práticas de gestão em saúde",
    "Ações de inteligência e ciências de dados e serviços de saúde digital",
    "Formação e educação permanente"
  ];
  const container = document.getElementById("eixos-container");
  eixos.forEach((titulo, i) => {
    const n = i + 1;
    container.innerHTML += `
      <div class="section">
        <h2 onclick="toggleAccordion('eixo${n}')">Eixo ${n} - ${titulo}</h2>
        <div class="accordion" id="eixo${n}"></div>
        <button class="add-action" onclick="addAction('eixo${n}')">Adicionar nova ação</button>
      </div>`;
  });
}

function generatePDF() {
  const date = new Date().toLocaleDateString();
  let content = `<h1>Plano de Ação - Programa Especial de Saúde do Rio Doce</h1>`;

  document.querySelectorAll('.section').forEach(section => {
    const title = section.querySelector('h2')?.textContent;
    content += `<h2>${title}</h2>`;
    const actions = section.querySelectorAll('.accordion-item');
    actions.forEach(item => {
      const header = item.querySelector('.accordion-header')?.textContent || 'Ação';
      content += `<div class="box"><h3>${header}</h3><ul>`;
      item.querySelectorAll('label').forEach(label => {
        const field = label.nextElementSibling;
        const value = field?.value || field?.textContent || 'Não preenchido';
        content += `<li><strong>${label.textContent}</strong>: ${value}</li>`;
      });
      content += `</ul></div>`;
    });
  });

  content += `<footer>Programa Especial de Saúde do Rio Doce<br>Emitido em ${date}</footer>`;

  const win = window.open();
  win.document.write(`
    <html lang="pt-BR">
      <head>
        <title>PDF</title>
        <style>
          body {
            font-family: Georgia, serif;
            padding: 40px 60px;
            color: #2b2b2b;
            line-height: 1.6;
            font-size: 14px;
          }
          h1 {
            text-align: center;
            font-size: 26px;
            color: #1a1a1a;
            margin-bottom: 40px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
          }
          h2 {
            font-size: 18px;
            margin-top: 30px;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
          }
          h3 {
            font-size: 16px;
            margin: 20px 0 10px;
            color: #444;
            font-weight: bold;
          }
          ul {
            list-style: none;
            padding-left: 0;
          }
          li {
            margin-bottom: 8px;
          }
          .box {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 25px;
            background: #fafafa;
          }
          footer {
            text-align: center;
            font-size: 12px;
            margin-top: 50px;
            border-top: 1px solid #ccc;
            padding-top: 15px;
            color: #666;
          }
        </style>
      </head>
      <body>${content}</body>
    </html>
  `);
  win.document.close();
  win.print();
}

document.addEventListener("DOMContentLoaded", () => {
  setupEixos();
});
